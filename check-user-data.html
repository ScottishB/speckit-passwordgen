<!DOCTYPE html>
<html>
<head>
  <title>Check User Data</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
    button { padding: 10px 20px; margin: 10px 0; cursor: pointer; }
    .highlight { background-color: yellow; font-weight: bold; }
  </style>
</head>
<body>
  <h1>User Data Check</h1>
  <button onclick="checkData()">Check LocalStorage & Database</button>
  <button onclick="clearAllData()">Clear All Data (Logout)</button>
  <div id="output"></div>

  <script>
    function checkData() {
      const output = document.getElementById('output');
      let html = '<h2>localStorage:</h2>';
      
      // Check session
      const sessionId = localStorage.getItem('pwgen_current_session');
      html += `<p><strong>pwgen_current_session:</strong> ${sessionId || 'null'}</p>`;
      
      // Check users
      const usersData = localStorage.getItem('pwgen_users');
      if (usersData) {
        try {
          const users = JSON.parse(usersData);
          html += `<h3>Users (${users.length}):</h3>`;
          users.forEach((user, i) => {
            html += `<h4>User ${i + 1}: ${user.username}</h4>`;
            html += `<pre>${JSON.stringify({
              id: user.id,
              username: user.username,
              totpSecret: user.totpSecret,
              totpSecretIsNull: user.totpSecret === null,
              totpSecretType: typeof user.totpSecret,
              backupCodes: user.backupCodes?.length || 0,
              backupCodesUsed: user.backupCodesUsed || [],
              createdAt: new Date(user.createdAt).toISOString(),
              lastLogin: user.lastLogin ? new Date(user.lastLogin).toISOString() : null,
              failedLoginAttempts: user.failedLoginAttempts,
              accountLockedUntil: user.accountLockedUntil
            }, null, 2)}</pre>`;
            
            // Highlight if 2FA is enabled
            if (user.totpSecret !== null && user.totpSecret !== undefined) {
              html += `<p class="highlight">⚠️ 2FA APPEARS ENABLED - totpSecret is: ${user.totpSecret}</p>`;
            } else {
              html += `<p>✓ 2FA is NOT enabled - totpSecret is null</p>`;
            }
          });
        } catch (e) {
          html += `<p style="color: red;">Error parsing users: ${e.message}</p>`;
        }
      } else {
        html += '<p>No users data found</p>';
      }
      
      // Check sessions
      const sessionsData = localStorage.getItem('pwgen_sessions');
      if (sessionsData) {
        try {
          const sessions = JSON.parse(sessionsData);
          html += `<h3>Sessions (${sessions.length}):</h3>`;
          html += `<pre>${JSON.stringify(sessions, null, 2)}</pre>`;
        } catch (e) {
          html += `<p style="color: red;">Error parsing sessions: ${e.message}</p>`;
        }
      } else {
        html += '<p>No sessions data found</p>';
      }
      
      output.innerHTML = html;
    }
    
    function clearAllData() {
      if (confirm('This will clear ALL data and logout. Continue?')) {
        localStorage.removeItem('pwgen_current_session');
        localStorage.removeItem('pwgen_users');
        localStorage.removeItem('pwgen_sessions');
        // Clear all vaults
        const keys = Object.keys(localStorage);
        keys.forEach(key => {
          if (key.startsWith('pwgen_vault_')) {
            localStorage.removeItem(key);
          }
        });
        alert('All data cleared! Reload the page.');
        location.reload();
      }
    }
    
    // Auto-check on load
    window.onload = checkData;
  </script>
</body>
</html>
